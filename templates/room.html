<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{type}} | Connect</title>
    <link rel="stylesheet" href="/static/login/login.css">
    <link rel="stylesheet" href="/static/connect/connect.css">
    <link rel="stylesheet" href="/static/room/room.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    {% comment %} <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> {% endcomment %}
    <script src="/static/room/room.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        setInterval(function(){
            $.ajax({
                type:'GET',
                url:'/getMessages/{{type}}/{{roomname}}',
                success: function(response){
                    $('#chat').empty();
                    for(var key in response.messages){
                        let temp;
                        let tym = response.messages[key].time;
                        time = tym.slice(0,10).split('-') // This is date
                        date = tym.slice(11,19) // This is time
                        if(response.messages[key]['user_id']==`{{request.user.id}}`){
                            temp = `<span class="msg r text-end"> <b class="d-block mb-1">You</b> ${response.messages[key].value} <span class="datetime text-start">${date} ${time[2]}-${time[1]}-${time[0]}</span></span>`
                        }
                        else{
                            temp = `<span class="msg text-start"> <b class="d-block mb-1">${response.messages[key].user_name}</b> ${response.messages[key].value} <span class="datetime text-end">${date} ${time[2]}-${time[1]}-${time[0]}</span> </span>`
                        }
                        $('#chat').append(temp);
                    }
                }
            })
        },1000)
    </script>
</head>
<body>
	<section class="login">
		<div class="login_box">
			<div class="left">
                <div class="head">
                    <h2>{{roomname}}</h2>
                    <button onclick="resetter()">&#8635;</button>
                </div>
                <div class="bottom">
                    <form id="postform">
                        {% csrf_token %}
                        <span class="textarea inputbox" id="inputbox" role="textbox" contenteditable>Enter your message...</span>
                        <hr class="invis">
                        <button type="submit"><img src="/static/send/send.png" alt="Send" style="height:20px;width:20px"></button>
                    </form>
                </div>
			</div>
			<div class="right">
                <div class="box" id="chat">
                    {% comment %} <span class="msg text-start"> <b class="d-block mb-1">User1</b> This is an enormous message typed by murtaza akil msiter will this work out?????????????This is an enormous message typed by murtaza akil msiter will this work out?????????????This is an enormous message typed by murtaza aork out?????????????? <span class="datetime text-end">11:04PM 02/01/2022</span> </span> {% endcomment %}
                    {% comment %} <span class="msg r text-end"> <b class="d-block mb-1">You</b> This is an enormous message typed by murtaza akil msiter will this work out?????????????This is an enormous message typed by murtaza akil msiter will this work out?????????????This is an enormous message typed by murtaza aork out??????????????<span class="datetime text-start">11:04PM 02/01/2022</span></span> {% endcomment %}
                </div>
			</div>
		</div>
	</section>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>
<script>
    $(document).ready(()=>{
        let d = $('#chat');
        setTimeout(()=>{d.scrollTop(d.prop("scrollHeight"));},2000)
    })
    user = "{{request.user}}"
    room = "{{roomname}}"
    roomtype = "{{type}}"
    $(document).on('submit','#postform',function(e){
        e.preventDefault();
        $.ajax({
            type:'POST',
            url:'/send/'+roomtype,
            data:{
                user: user,
                room: room,
                value: $('#inputbox').text(),
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
            },
            success: function(data){
                {% comment %} alert(data); {% endcomment %}
                $('#inputbox').html("Enter your message...")
                let d = $('#chat');
                setTimeout(()=>{d.scrollTop(d.prop("scrollHeight"));},500)
            }
        });
    });
</script>
</html>